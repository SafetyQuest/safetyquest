generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "sqlserver"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id                 String              @id @default(cuid())
  email              String              @unique
  name               String
  passwordHash       String?
  role               String?
  section            String?
  department         String?
  supervisor         String?
  manager            String?
  designation        String?
  userTypeId         String?
  xp                 Int                 @default(0)
  level              Int                 @default(1)
  streak             Int                 @default(0)
  lastActivity       DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  roleId             String?

  // ðŸ†• PASSWORD CHANGE TRACKING
  mustChangePassword Boolean             @default(true)
  lastPasswordChange DateTime?

  courseAssignments  CourseAssignment[]
  courseAttempts     CourseAttempt[]
  lessonAttempts     LessonAttempt[]
  lessonProgress     LessonProgress[]
  programAssignments ProgramAssignment[]
  quizAttempts       QuizAttempt[]
  refreshers         RefresherSchedule[]
  roleModel          Role?               @relation("UserRole", fields: [roleId], references: [id])
  userType           UserType?           @relation(fields: [userTypeId], references: [id])
  badges             UserBadge[]

  @@index([email])
  @@index([roleId])
  @@index([userTypeId])
  @@index([department])
  @@index([section])
}

model UserType {
  id          String                      @id @default(cuid())
  name        String                      @unique
  slug        String                      @unique
  description String?
  createdAt   DateTime                    @default(now())
  users       User[]
  courses     UserTypeCourseAssignment[]
  programs    UserTypeProgramAssignment[]

  @@index([slug])
}

model Program {
  id              String                      @id @default(cuid())
  title           String                      @unique
  slug            String                      @unique
  description     String?
  isActive        Boolean                     @default(true)
  createdAt       DateTime                    @default(now())
  userAssignments ProgramAssignment[]
  courses         ProgramCourse[]
  refreshers      RefresherSchedule[]
  userTypes       UserTypeProgramAssignment[]

  @@index([slug])
  @@index([isActive])
}

model UserTypeProgramAssignment {
  id         String   @id @default(cuid())
  userTypeId String
  programId  String
  createdAt  DateTime @default(now())
  program    Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  userType   UserType @relation(fields: [userTypeId], references: [id], onDelete: Cascade)

  @@unique([userTypeId, programId])
  @@index([userTypeId])
  @@index([programId])
}

model UserTypeCourseAssignment {
  id         String   @id @default(cuid())
  userTypeId String
  courseId   String
  createdAt  DateTime @default(now())
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  userType   UserType @relation(fields: [userTypeId], references: [id], onDelete: Cascade)

  @@unique([userTypeId, courseId])
  @@index([userTypeId])
  @@index([courseId])
}

model ProgramAssignment {
  id         String   @id @default(cuid())
  userId     String
  programId  String
  source     String
  isActive   Boolean  @default(true)
  assignedBy String?
  assignedAt DateTime @default(now())
  program    Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, programId, source])
  @@index([userId])
  @@index([programId])
  @@index([isActive])
  @@index([source])
}

model CourseAssignment {
  id         String   @id @default(cuid())
  userId     String
  courseId   String
  source     String
  isActive   Boolean  @default(true)
  assignedBy String?
  assignedAt DateTime @default(now())
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId, source])
  @@index([userId])
  @@index([courseId])
  @@index([isActive])
  @@index([source])
}

model Course {
  id              String                     @id @default(cuid())
  title           String                     @unique
  slug            String                     @unique
  description     String?
  difficulty      String                     @default("Beginner")
  quizId          String?
  createdAt       DateTime                   @default(now())
  quiz            Quiz?                      @relation(fields: [quizId], references: [id])
  userAssignments CourseAssignment[]
  attempts        CourseAttempt[]
  lessons         CourseLesson[]
  tags            CourseTag[]
  programs        ProgramCourse[]
  userTypes       UserTypeCourseAssignment[]

  @@index([slug])
  @@index([difficulty])
}

model ProgramCourse {
  id        String  @id @default(cuid())
  programId String
  courseId  String
  order     Int     @default(0)
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([programId, courseId])
  @@index([programId])
  @@index([courseId])
  @@index([order])
}

model Lesson {
  id          String           @id @default(cuid())
  title       String           @unique
  slug        String           @unique
  description String?
  difficulty  String           @default("Beginner")
  quizId      String?
  createdAt   DateTime         @default(now())
  courses     CourseLesson[]
  quiz        Quiz?            @relation(fields: [quizId], references: [id])
  attempts    LessonAttempt[]
  progress    LessonProgress[]
  steps       LessonStep[]
  tags        LessonTag[]

  @@index([slug])
  @@index([difficulty])
}

model CourseLesson {
  id       String @id @default(cuid())
  courseId String
  lessonId String
  order    Int    @default(0)
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson   Lesson @relation(fields: [lessonId], references: [id], onUpdate: NoAction)

  @@unique([courseId, lessonId])
  @@index([courseId])
  @@index([lessonId])
  @@index([order])
}

model LessonProgress {
  id               String   @id @default(cuid())
  userId           String
  lessonId         String
  currentStepIndex Int      @default(0)
  completedSteps   String   @db.NVarChar(Max)
  accumulatedXp    Int      @default(0)
  startedAt        DateTime @default(now())
  lastActivityAt   DateTime @updatedAt
  stepResults      String?  @db.NVarChar(Max)
  lesson           Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@index([lastActivityAt])
}

model LessonStep {
  id          String  @id @default(cuid())
  order       Int
  type        String
  contentType String?
  contentData String? @db.NVarChar(Max)
  gameType    String?
  gameConfig  String? @db.NVarChar(Max)
  lessonId    String
  lesson      Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@index([order])
}

model Quiz {
  id           String         @id @default(cuid())
  title        String         @unique
  slug         String         @unique
  description  String?
  type         String
  passingScore Int            @default(80)
  createdAt    DateTime       @default(now())
  courseUsage  Course[]
  lessonUsage  Lesson[]
  attempts     QuizAttempt[]
  questions    QuizQuestion[]

  @@index([slug])
  @@index([type])
}

model QuizQuestion {
  id         String @id @default(cuid())
  quizId     String
  order      Int
  difficulty Int    @default(3)
  gameType   String
  gameConfig String @db.NVarChar(Max)
  points     Int    @default(10)
  quiz       Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([order])
  @@index([difficulty])
}

model Tag {
  id      String      @id @default(cuid())
  name    String      @unique
  slug    String      @unique
  courses CourseTag[]
  lessons LessonTag[]

  @@index([slug])
}

model CourseTag {
  id       String @id @default(cuid())
  courseId String
  tagId    String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([courseId, tagId])
  @@index([courseId])
  @@index([tagId])
}

model LessonTag {
  id       String @id @default(cuid())
  lessonId String
  tagId    String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([lessonId, tagId])
  @@index([lessonId])
  @@index([tagId])
}

model LessonAttempt {
  id           String   @id @default(cuid())
  userId       String
  lessonId     String
  contentCompleted Boolean  @default(false)
  quizAttempted    Boolean  @default(false)
  quizScore    Int
  quizMaxScore Int
  passed       Boolean
  timeSpent    Int?
  completedAt  DateTime @default(now())
  lesson       Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@index([passed])
  @@index([contentCompleted])
}

model CourseAttempt {
  id           String   @id @default(cuid())
  userId       String
  courseId     String
  quizScore    Int
  quizMaxScore Int
  passed       Boolean
  completedAt  DateTime @default(now())
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([passed])
}

model QuizAttempt {
  id          String   @id @default(cuid())
  userId      String
  quizId      String
  score       Int
  maxScore    Int
  passed      Boolean
  answers     String   @db.NVarChar(Max)
  completedAt DateTime @default(now())
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@index([passed])
}

model Badge {
  id          String      @id @default(cuid())
  name        String      @unique
  description String?
  iconUrl     String?
  criteria    String      @db.NVarChar(Max)
  createdAt   DateTime    @default(now())
  userBadges  UserBadge[]

  @@index([name])
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  awardedAt DateTime @default(now())
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
}

model RefresherSchedule {
  id             String    @id @default(cuid())
  userId         String
  programId      String
  nextDue        DateTime
  intervalMonths Int
  lastSent       DateTime?
  program        Program   @relation(fields: [programId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, programId])
  @@index([nextDue])
  @@index([userId])
}

model EmailLog {
  id       String   @id @default(cuid())
  to       String
  subject  String
  template String
  status   String
  metadata String?  @db.NVarChar(Max)
  sentAt   DateTime @default(now())

  @@index([to])
  @@index([sentAt])
  @@index([status])
}

model Role {
  id              String           @id @default(cuid())
  name            String           @unique
  slug            String           @unique
  description     String?          @db.NVarChar(500)
  isSystem        Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[] @relation("RolePermissions")
  users           User[]           @relation("UserRole")

  @@index([slug])
  @@index([isSystem])
}

model Permission {
  id              String           @id @default(cuid())
  name            String           @unique
  resource        String
  action          String
  description     String?          @db.NVarChar(500)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[] @relation("PermissionRoles")

  @@index([resource])
  @@index([action])
  @@index([resource, action])
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  permission   Permission @relation("PermissionRoles", fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation("RolePermissions", fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}
